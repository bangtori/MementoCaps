##  Capsule 엔티티에 writer 정보를 어떻게 처리할 것인가
**미션5 진행중**

## 🛑 문제 상황
타임캡슐을 생성하면 해당 캡슐의 작성자가 OWNER로써 관계 테이블(User_Capsule)에 등록되어야 합니다. <br>
즉, 타임캡슐 생성과 동시에 작성자-캡슐 관계도 함께 저장되어야 하는데, <br>
미션 진행 전 두 테이블을 어떤 순서로 저장할지, 그리고 그 로직을 어떻게 하나의 흐름으로 처리할 수 있을지 고민이 되었습니다.

- 처음에는 Capsule 엔티티에서 생성자 파라미터로 writer: User를 넘긴 뒤, 내부에서 작성자 정보를 UserCapsule로 매핑하는 방식을 사용했습니다.
- 하지만 실제로 제가 설계한 테이블은 Capsule 엔티티에는 writer 필드가 존재하지 않고, UserCapsule(role = OWNER)로만 작성자를 식별하는 구조였습니다.


## 🔍 분석
- UserCapsule 테이블에서 role = OWNER 정보를 통해 작성자를 구분할 수 있기에 Capsule에 직접 writer 필드가 없어도 됐습니다.
- 구조 자체는 문제 없지만, this를 엔티티 생성 시점(init)에서 바로 사용하는 부분이 다소 위험할 수 있다는 점이 고민되었습니다.
- 또한, 작성자 외 다른 유저(=멤버)를 추가할 때도 유사한 방식으로 로직을 확장해야 했기에, 엔티티의 책임이 커지는 느낌을 받았습니다.

## 🛠 해결 방법
결론적으로, UserCapsule은 capsule.id, user.id가 모두 필요한 관계이므로 <br>
캡슐을 먼저 저장 → 관계를 이후에 저장하는 방식이 더 명확하다고 판단했다.

저장 순서는 다음과 같습니다. <br>
**캡슐 생성 로직 실행**
1. 캡슐 테이블에 (작성자 정보 없이 순수한 캡슐 데이터만 있는) 캡슐 정보 저장 
2. 입력받은 작성자 아이디를 가지고 user 테이블에서 user 정보 얻기
3. 저장된 캡슐 데이터에서 방금 작성한 캡슐 정보 얻기
4. 캡슐정보와 유저 정보를 매핑 (Role = OWNER)후 저장

이렇게 하게되면 UserCapsuleRepository의 save 로 멤버와 작성자 모두 처리가 가능합니다. <br>

즉 서비스 단에서 "캡슐 저장"이라는 비지니스 로직은 다음과 같이 정의됩니다. 
- 캡슐 데이터를 저장한다.
- 작성자 데이터를 가져온다.
- 캡슐 데이터와 작성자 데이터를 매핑하여 OWNER라는 Role 값으로 유저캡슐 데이터에 저장한다.

이렇게 구조를 바꾸니 멤버를 추가할때도 엔티티의 책임은 덜어내고 비슷한 방식으로 처리가 가능했습니다.
- 캡슐 데이터를 불러옵니다.
- 초대된 사용자 데이터를 불러옵니다.
- 두 데이터를 매핑하여 MEMBER 라는 Role 값으로 유저 캡슐 데이터에 저장합니다.


## 🎯 마무리
- 작성자 정보를 캡슐 엔티티 내부에서 자동으로 넣기보다는, 서비스에서 명확히 처리하는 것이 더 안전하고 역할 분리에도 적절하다는 것을 배웠습니다.
- 특히 N:M 관계에서 관계 테이블을 직접 저장해야 하는 상황에서는, 엔티티를 먼저 저장 → 관계를 이어주는 순서가 중요하다는 것을 느꼈습니다.
- 구조를 이렇게 바꾸고 나니, 멤버 추가 같은 기능도 일관된 방식으로 확장할 수 있어 훨씬 깔끔한 구조의 느낌을 받을 수 있었습니다.